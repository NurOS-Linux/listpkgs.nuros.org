name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Frontend"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Убедимся, что деплой запускается только если build_frontend успешно завершился
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download frontend artifact from build workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get artifact download URL from the build_frontend workflow run
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run trigger, get artifact from the triggering workflow
            ARTIFACT_ID=$(gh api \
              repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
              -q '.artifacts[] | select(.name=="frontend-dist") | .id' | head -1)
            
            if [ -z "$ARTIFACT_ID" ]; then
              echo "❌ frontend-dist artifact not found"
              exit 1
            fi
            
            echo "Found artifact ID: $ARTIFACT_ID"
            mkdir -p ./temp-frontend-dist
            gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip \
              -H "Accept: application/vnd.github.v3.raw" > artifact.zip
            unzip -d ./temp-frontend-dist artifact.zip
            rm artifact.zip
          else
            echo "Manual workflow_dispatch: using previous build artifacts"
            mkdir -p ./temp-frontend-dist
          fi
          
          echo "✅ Artifact processed"
          ls -la ./temp-frontend-dist/

      - name: Prepare deployment directory
        run: |
          # Очищаем все кроме .git
          find . -mindepth 1 -not -name '.git*' -delete
          
          # Копируем новый фронтенд
          cp -r ./temp-frontend-dist/* ./
          rm -rf ./temp-frontend-dist

      - name: Verify artifact contents
        run: |
          echo "Checking deployed files:"
          ls -la ./
          
          if [ ! -f "index.html" ]; then
            echo "ERROR: index.html not found"
            exit 1
          fi
          echo "✅ Deployment files verified"

      - name: Commit and push to gh-pages
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add .
          
          # Проверяем есть ли изменения
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: deploy frontend to gh-pages [skip ci]"
            git push origin gh-pages
            echo "✅ Deployed to gh-pages branch"
          fi