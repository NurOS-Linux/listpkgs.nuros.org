name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Frontend"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download frontend artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./dist
        continue-on-error: true

      - name: Fallback - download from workflow run if artifact not found
        if: steps.download.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Trying to download artifact from workflow run..."
          ARTIFACT_ID=$(gh api \
            repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
            -q '.artifacts[] | select(.name=="frontend-dist") | .id' | head -1)

          if [ -z "$ARTIFACT_ID" ]; then
            echo "âŒ frontend-dist artifact not found"
            exit 1
          fi

          echo "Downloading artifact ID: $ARTIFACT_ID"
          mkdir -p ./dist
          gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip \
            -H "Accept: application/vnd.github.v3.raw" > artifact.zip
          unzip -o -q artifact.zip -d ./dist
          rm artifact.zip

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
