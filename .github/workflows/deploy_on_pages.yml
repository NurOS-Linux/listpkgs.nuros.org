name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Frontend"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ build_frontend —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download frontend artifact from build workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get artifact download URL from the build_frontend workflow run
            ARTIFACT_ID=$(gh api \
              repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
              -q '.artifacts[] | select(.name=="frontend-dist") | .id' | head -1)
            
            if [ -z "$ARTIFACT_ID" ]; then
              echo "‚ùå frontend-dist artifact not found"
              exit 1
            fi
            
            echo "Downloading artifact ID: $ARTIFACT_ID"
            gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip \
              -H "Accept: application/vnd.github.v3.raw" > artifact.zip
            
            # Extract and flatten directory structure
            echo "Extracting artifact..."
            unzip -o -q artifact.zip
            rm artifact.zip
            
            # List extracted structure
            echo "Extracted structure:"
            find . -maxdepth 3 -type f | grep -v '.git' | head -20
            
          else
            echo "Manual workflow_dispatch - skipping artifact download"
          fi

      - name: Prepare deployment directory
        run: |
          echo "üìÅ Current directory structure:"
          ls -la ./
          
          # Preserve repodata.json before clearing
          if [ -f "repodata.json" ]; then
            echo "‚úÖ Found repodata.json - will preserve it"
            cp repodata.json /tmp/repodata.json.backup
          fi
          
          # Find dist directory or files
          if [ -d "dist" ]; then
            echo "‚úÖ Found 'dist' directory"
            # Clear everything except .git and move dist files to root
            find . -mindepth 1 -maxdepth 1 -not -name '.git*' -not -name 'dist' -exec rm -rf {} + 2>/dev/null || true
            cp -r dist/* ./
            rm -rf dist
          else
            echo "‚ö†Ô∏è  'dist' directory not found, checking current files..."
            ls -la ./
            # If dist doesn't exist but we have index.html, we're good
            if [ ! -f "index.html" ]; then
              find . -name "index.html" -type f
              echo "‚ùå Could not find index.html anywhere"
              exit 1
            fi
          fi
          
          # Restore repodata.json if we backed it up
          if [ -f "/tmp/repodata.json.backup" ]; then
            echo "‚úÖ Restoring repodata.json"
            cp /tmp/repodata.json.backup repodata.json
          fi
          
          echo ""
          echo "‚úÖ Files ready for deployment:"
          ls -la ./

      - name: Verify essential files
        run: |
          echo "üìã Verifying essential deployment files..."
          
          # Check for index.html
          if [ ! -f "index.html" ]; then
            echo "‚ùå index.html not found"
            exit 1
          fi
          echo "‚úÖ index.html found"
          
          # Check for repodata.json
          if [ ! -f "repodata.json" ]; then
            echo "‚ùå repodata.json not found"
            echo "Available files:"
            ls -la ./
            exit 1
          fi
          echo "‚úÖ repodata.json found ($(stat -f%z repodata.json || stat -c%s repodata.json) bytes)"
          
          # Check for logo
          if [ ! -f "plymoth_adeki_logo.gif" ]; then
            echo "‚ö†Ô∏è  plymoth_adeki_logo.gif not found"
          else
            echo "‚úÖ plymoth_adeki_logo.gif found"
          fi
          
          echo ""
          echo "üìÅ Final deployment structure:"
          ls -la ./

      - name: Commit and push to gh-pages
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check for changes
          echo "Checking for changes..."
          git status
          
          git add .
          
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "üìù Committing changes..."
            git commit -m "chore: deploy frontend build to gh-pages [skip ci]"
            echo "üöÄ Pushing to gh-pages..."
            git push origin gh-pages
            echo "‚úÖ Successfully deployed to gh-pages"
          fi