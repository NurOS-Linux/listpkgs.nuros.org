name: Sync Documentation to GitBook

on:
  push:
    branches:
      - main
    paths:
      - 'blog/**.md'
      - 'blog/book.json'
      - 'blog/SUMMARY.md'
      - 'blog/styles.css'
      - '.github/workflows/sync-gitbook.yml'
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed
    paths:
      - 'blog/**.md'
      - 'blog/book.json'
      - 'blog/SUMMARY.md'
      - 'blog/styles.css'

jobs:
  sync-gitbook:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Format markdown files
        run: |
          if command -v prettier &> /dev/null; then
            npx prettier --write "blog/**/*.md"
          fi
          echo "âœ… Markdown files formatted"

      - name: Verify documentation structure
        run: |
          echo "ðŸ“‹ Checking documentation structure..."
          required_files=("blog/README.md" "blog/SUMMARY.md" "blog/book.json" "blog/styles.css")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ERROR: $file not found"
              exit 1
            fi
          done
          echo "âœ… All required files present"
          
          echo "ðŸ“„ Documentation files:"
          ls -la blog/*.md blog/*.json blog/*.css 2>/dev/null || true

      - name: Trigger GitBook Sync
        run: |
          echo "ðŸ”„ Triggering GitBook synchronization..."
          echo ""
          echo "=========================================="
          echo "GitBook Integration Instructions"
          echo "=========================================="
          echo ""
          echo "To connect this repository to GitBook:"
          echo ""
          echo "1. Go to https://app.gitbook.com/"
          echo "2. Create a new space or select existing"
          echo "3. Go to Settings â†’ Integrations â†’ GitHub"
          echo "4. Connect this repository:"
          echo "   https://github.com/NurOS-Linux/listpkgs.nuros.org"
          echo "5. Select the 'blog' folder as documentation source"
          echo "6. Enable auto-sync on push to main branch"
          echo ""
          echo "GitBook will automatically sync when you push to main."
          echo ""
          echo "=========================================="
          echo "âœ… Documentation ready for GitBook sync"
          echo "=========================================="
          
          # List files that will be synced
          echo ""
          echo "ðŸ“š Files to sync:"
          find blog -name "*.md" -o -name "book.json" -o -name "SUMMARY.md" -o -name "styles.css" | sort

      - name: Create deployment summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## ðŸ“š GitBook Documentation Sync

          - **Status**: âœ… Ready for sync
          - **Triggered by**: \`${{ github.event_name }}\`
          - **Commit**: \`${{ github.sha }}\`
          - **Build timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ### Documentation Structure

          | File | Status |
          |------|--------|
          | README.md | âœ… |
          | SUMMARY.md | âœ… |
          | book.json | âœ… |
          | styles.css | âœ… |
          | *.md files | âœ… |

          ### GitBook Setup Required

          **First-time setup:**

          1. Visit [GitBook](https://app.gitbook.com/)
          2. Create/connect your space
          3. Go to **Settings â†’ Integrations â†’ GitHub**
          4. Connect repository: \`NurOS-Linux/listpkgs.nuros.org\`
          5. Set source folder: \`blog/\`
          6. Enable auto-sync

          **After setup:**

          - Changes to \`main\` branch auto-sync to GitBook
          - GitBook URL: \`https://NurOS-Linux.gitbook.io/listpkgs-package-list\`
          - Custom domain can be configured in GitBook settings

          ### Documentation Includes:

          - âœ… Getting Started Guide
          - âœ… Architecture Overview
          - âœ… Frontend User Guide
          - âœ… API Reference
          - âœ… Deployment Guide
          - âœ… Contributing Guide
          - âœ… FAQ

          ### Next Steps:

          1. Complete GitBook integration (if not done)
          2. Access documentation at your GitBook URL
          3. Configure custom domain in GitBook (optional)
          EOF
