name: Build Frontend

on:
  workflow_run:
    workflows: ["Update NurOS Package List"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  check-lint:
    runs-on: ubuntu-latest
    outputs:
      lint-passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check lint status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest lint run for the commit
          LINT_RESULT=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "Lint Frontend" \
            -s success \
            --limit 1 \
            --json conclusion \
            -q '.[0].conclusion // "unknown"')
          
          echo "Latest lint result: $LINT_RESULT"
          
          if [ "$LINT_RESULT" = "success" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lint passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Lint failed or not run"
          fi

  build:
    needs: check-lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      (github.event_name == 'workflow_dispatch') ||
      ((github.event.workflow_run.conclusion == 'success') && (needs.check-lint.outputs.lint-passed == 'true'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download repodata artifact
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üì• Attempting to download latest repodata..."
          
          # Get the latest successful update-list run
          UPDATE_RUN=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "Update NurOS Package List" \
            -s success \
            --limit 1 \
            --json databaseId \
            -q '.[0].databaseId // ""')
          
          if [ -z "$UPDATE_RUN" ]; then
            echo "‚ÑπÔ∏è  No update-list run found, using committed version"
            exit 0
          fi
          
          # Get artifact ID
          ARTIFACT=$(gh api \
            repos/${{ github.repository }}/actions/runs/$UPDATE_RUN/artifacts \
            -q '.artifacts[] | select(.name=="repodata-json") | .id // ""') 
          
          if [ -z "$ARTIFACT" ]; then
            echo "‚ÑπÔ∏è  No repodata artifact found, using committed version"
            exit 0
          fi
          
          # Download and extract
          mkdir -p listpkgs.nuros.front-end/public
          
          echo "Downloading artifact..."
          gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT/zip \
            -H "Accept: application/vnd.github.v3.raw" > /tmp/repodata.zip
          
          echo "Extracting..."
          unzip -o /tmp/repodata.zip -d listpkgs.nuros.front-end/public/
          rm /tmp/repodata.zip
          
          echo "‚úÖ Downloaded latest repodata files"
          ls -lh listpkgs.nuros.front-end/public/repodata.json* 2>/dev/null || true

      - name: Verify source data exists
        run: |
          if [ ! -f "listpkgs.nuros.front-end/public/repodata.json" ]; then
            echo "‚ùå ERROR: repodata.json not found in public/"
            echo "This will cause the site to have no packages!"
            echo "Available files:"
            ls -la listpkgs.nuros.front-end/public/ || echo "public/ directory is empty"
            exit 1
          fi
          echo "‚úÖ Source data verified"
          wc -l listpkgs.nuros.front-end/public/repodata.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'listpkgs.nuros.front-end/pnpm-lock.yaml'

      - name: Enable pnpm
        run: corepack enable pnpm

      - name: Install dependencies
        run: |
          cd listpkgs.nuros.front-end
          pnpm install --frozen-lockfile

      - name: Build frontend
        run: |
          cd listpkgs.nuros.front-end
          pnpm build
          echo "‚úÖ Build complete"
          du -sh dist/
          ls -1 dist/ | head -10

      - name: Copy repodata to dist
        run: |
          # Ensure repodata is in dist (Vite should copy from public, but verify)
          if [ ! -f "listpkgs.nuros.front-end/dist/repodata.json" ]; then
            cp listpkgs.nuros.front-end/public/repodata.json listpkgs.nuros.front-end/dist/
            echo "‚ÑπÔ∏è  Manually copied repodata.json to dist"
          else
            echo "‚úÖ repodata.json already in dist"
          fi
          
          if [ -f "listpkgs.nuros.front-end/public/repodata.json.sha256" ]; then
            cp listpkgs.nuros.front-end/public/repodata.json.sha256 listpkgs.nuros.front-end/dist/
          fi

      - name: Verify build artifacts
        run: |
          if [ ! -f "listpkgs.nuros.front-end/dist/index.html" ]; then
            echo "‚ùå ERROR: index.html not found in dist/"
            exit 1
          fi
          if [ ! -f "listpkgs.nuros.front-end/dist/repodata.json" ]; then
            echo "‚ùå ERROR: repodata.json not found in dist/"
            exit 1
          fi
          echo "‚úÖ All critical files present in dist/"
          echo "üìä Dist contents:"
          ls -lh listpkgs.nuros.front-end/dist/index.html
          ls -lh listpkgs.nuros.front-end/dist/repodata.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: listpkgs.nuros.front-end/dist/
          retention-days: 7
          compression-level: 9
