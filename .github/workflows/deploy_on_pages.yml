name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Frontend"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ build_frontend —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download frontend artifact from build workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get artifact download URL from the build_frontend workflow run
            ARTIFACT_ID=$(gh api \
              repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
              -q '.artifacts[] | select(.name=="frontend-dist") | .id' | head -1)
            
            if [ -z "$ARTIFACT_ID" ]; then
              echo "‚ùå frontend-dist artifact not found"
              exit 1
            fi
            
            echo "Downloading artifact ID: $ARTIFACT_ID"
            gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip \
              -H "Accept: application/vnd.github.v3.raw" > artifact.zip
            
            # Extract and flatten directory structure
            echo "Extracting artifact..."
            unzip -o -q artifact.zip
            rm artifact.zip
            
            # List extracted structure
            echo "Extracted structure:"
            find . -maxdepth 3 -type f | grep -v '.git' | head -20
            
          else
            echo "Manual workflow_dispatch - skipping artifact download"
          fi

      - name: Prepare deployment directory
        run: |
          echo "üìÅ Current directory structure:"
          ls -la ./
          
          # Find dist directory or files
          if [ -d "dist" ]; then
            echo "‚úÖ Found 'dist' directory"
            # Clear everything except .git and move dist files to root
            find . -mindepth 1 -maxdepth 1 -not -name '.git*' -not -name 'dist' -exec rm -rf {} + 2>/dev/null || true
            cp -r dist/* ./
            rm -rf dist
          else
            echo "‚ö†Ô∏è  'dist' directory not found, checking current files..."
            ls -la ./
            # If dist doesn't exist but we have index.html, we're good
            if [ ! -f "index.html" ]; then
              find . -name "index.html" -type f
              echo "‚ùå Could not find index.html anywhere"
              exit 1
            fi
          fi
          
          echo ""
          echo "‚úÖ Files ready for deployment:"
          ls -la ./

      - name: Add repodata and verify SHA256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üì¶ Fetching repodata from main branch..."
          
          # Fetch main branch to get the latest repodata
          git fetch origin main --depth=1
          
          # Copy repodata.json if it exists
          if [ -f "listpkgs.nuros.front-end/public/repodata.json" ]; then
            cp listpkgs.nuros.front-end/public/repodata.json ./repodata.json
            echo "‚úÖ repodata.json added"
          else
            echo "‚ö†Ô∏è  repodata.json not found on main branch"
          fi
          
          # Copy and verify SHA256
          if [ -f "listpkgs.nuros.front-end/public/repodata.json.sha256" ]; then
            cp listpkgs.nuros.front-end/public/repodata.json.sha256 ./repodata.json.sha256
            echo "‚úÖ repodata.json.sha256 copied"
            
            # Verify SHA256 checksum
            echo ""
            echo "üîç Verifying SHA256 checksum..."
            if sha256sum -c repodata.json.sha256; then
              echo "‚úÖ SHA256 verification PASSED"
            else
              echo "‚ùå SHA256 verification FAILED"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  repodata.json.sha256 not found - skipping SHA256 verification"
          fi

      - name: Verify artifact contents
        run: |
          echo "Files in 'gh-pages' directory after preparation:"
          ls -la ./
          
          if [ ! -f "index.html" ]; then
            echo "‚ö†Ô∏è  index.html not found in root"
            echo "Checking subdirectories..."
            find . -name "index.html" -type f
            exit 1
          fi
          echo "‚úÖ index.html found - deployment ready"

      - name: Commit and push to gh-pages
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check for changes
          echo "Checking for changes..."
          git status
          
          git add .
          
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "üìù Committing changes..."
            git commit -m "chore: deploy frontend build to gh-pages [skip ci]"
            echo "üöÄ Pushing to gh-pages..."
            git push origin gh-pages
            echo "‚úÖ Successfully deployed to gh-pages"
          fi