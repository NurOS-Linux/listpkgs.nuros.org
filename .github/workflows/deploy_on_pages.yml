name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Frontend"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download frontend artifact from build workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading frontend artifact..."
          
          # Get the build workflow ID from the triggered event
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BUILD_RUN_ID="${{ github.event.workflow_run.id }}"
          else
            # For manual dispatch, get the latest successful build run
            echo "No workflow_run event, finding latest successful build..."
            BUILD_RUN_ID=$(gh run list \
              --repo ${{ github.repository }} \
              --workflow "Build Frontend" \
              --status completed \
              --conclusion success \
              --limit 1 \
              --json databaseId \
              -q '.[0].databaseId')
            
            if [ -z "$BUILD_RUN_ID" ]; then
              echo "âŒ No successful build run found"
              exit 1
            fi
          fi
          
          echo "Using build run ID: $BUILD_RUN_ID"
          
          # Get artifact from the build run
          ARTIFACT_ID=$(gh api \
            repos/${{ github.repository }}/actions/runs/$BUILD_RUN_ID/artifacts \
            -q '.artifacts[] | select(.name=="frontend-dist") | .id' | head -1)
          
          if [ -z "$ARTIFACT_ID" ]; then
            echo "âŒ frontend-dist artifact not found in build run $BUILD_RUN_ID"
            gh api repos/${{ github.repository }}/actions/runs/$BUILD_RUN_ID/artifacts -q '.artifacts[].name'
            exit 1
          fi
          
          echo "âœ… Found artifact ID: $ARTIFACT_ID"
          
          # Download and extract
          mkdir -p ./dist
          gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip \
            -H "Accept: application/vnd.github.v3.raw" > artifact.zip
          
          unzip -o -q artifact.zip -d ./dist
          rm artifact.zip
          
          echo "âœ… Artifact extracted"
          echo "ğŸ“ Contents:"
          ls -la ./dist

      - name: Verify dist directory exists
        run: |
          if [ ! -f "./dist/index.html" ]; then
            echo "âŒ index.html not found in dist. Deployment failed."
            echo "Available files:"
            find ./dist -type f | head -20
            exit 1
          fi
          echo "âœ… dist directory ready for deployment"
          echo "ğŸ“‹ Final contents:"
          ls -la ./dist

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
