name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Frontend"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ build_frontend —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download frontend artifact from build workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get artifact download URL from the build_frontend workflow run
            ARTIFACT_ID=$(gh api \
              repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
              -q '.artifacts[] | select(.name=="frontend-dist") | .id' | head -1)
            
            if [ -z "$ARTIFACT_ID" ]; then
              echo "‚ùå frontend-dist artifact not found"
              exit 1
            fi
            
            echo "Downloading artifact ID: $ARTIFACT_ID"
            gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip \
              -H "Accept: application/vnd.github.v3.raw" > artifact.zip
            
            # Create temp directory and extract
            mkdir -p ./temp-extract
            unzip -q artifact.zip -d ./temp-extract
            rm artifact.zip
            
            # List what was extracted
            echo "Extracted files:"
            find ./temp-extract -type f | head -20
            
            # Find the actual content directory and move to temp-frontend-dist
            if [ -d "./temp-extract" ]; then
              mkdir -p ./temp-frontend-dist
              # Copy everything from extraction directory
              cp -r ./temp-extract/* ./temp-frontend-dist/ 2>/dev/null || true
              rm -rf ./temp-extract
            fi
          else
            echo "Manual workflow_dispatch - creating empty directory"
            mkdir -p ./temp-frontend-dist
          fi
          
          echo "Files to deploy:"
          ls -la ./temp-frontend-dist/ || echo "Directory is empty or doesn't exist"

      - name: Prepare deployment directory
        run: |
          echo "Current directory structure:"
          ls -la ./
          
          echo ""
          echo "Files in temp-frontend-dist:"
          if [ -d "./temp-frontend-dist" ]; then
            ls -la ./temp-frontend-dist/ || echo "Directory exists but is empty"
          else
            echo "temp-frontend-dist directory not found"
          fi
          
          # –û—á–∏—â–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ .git
          find . -mindepth 1 -not -name '.git*' -delete
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
          if [ -d "./temp-frontend-dist" ] && [ "$(ls -A ./temp-frontend-dist)" ]; then
            cp -r ./temp-frontend-dist/* ./
            cp -r ./temp-frontend-dist/.[!.]* ./ 2>/dev/null || true
            rm -rf ./temp-frontend-dist
            echo "‚úÖ Files copied successfully"
          else
            echo "‚ö†Ô∏è  No files to copy"
          fi

      - name: Verify artifact contents
        run: |
          echo "Files in 'gh-pages' directory after preparation:"
          ls -la ./
          
          if [ ! -f "index.html" ]; then
            echo "‚ö†Ô∏è  index.html not found in root"
            echo "Checking subdirectories..."
            find . -name "index.html" -type f
            exit 1
          fi
          echo "‚úÖ index.html found - deployment ready"

      - name: Commit and push to gh-pages
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check for changes
          echo "Checking for changes..."
          git status
          
          git add .
          
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "üìù Committing changes..."
            git commit -m "chore: deploy frontend build to gh-pages [skip ci]"
            echo "üöÄ Pushing to gh-pages..."
            git push origin gh-pages
            echo "‚úÖ Successfully deployed to gh-pages"
          fi